<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社區SOS緊急系統</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        /* 載入中... 的動畫 */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* SOS 按鈕的呼吸效果 */
        #sos-button:not(:disabled) {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
        }
        /* 錯誤提示框 */
        .error-box {
            background-color: #fef2f2; /* red-50 */
            border: 1px solid #fecaca; /* red-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        /* 設定區塊樣式 */
        .settings-box {
            background-color: #f3f4f6; /* gray-100 */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- 容器 -->
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 md:p-8">

        <!-- 0. 載入中畫面 -->
        <div id="loading-view">
            <div class="flex flex-col items-center justify-center min-h-[200px]">
                <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
                <p id="loading-text" class="text-gray-500 mt-4">系統載入中...</p>
                <div id="firebase-error-box" class="error-box hidden w-full">
                    <p class="font-bold text-red-800">Firebase 連線失敗</p>
                    <p id="firebase-error-message" class="text-sm text-red-600 mt-2"></p>
                </div>
            </div>
        </div>

        <!-- 1. 入口選擇畫面 -->
        <div id="portal-view" class="hidden">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">社區SOS系統</h1>
            <div class="space-y-4">
                <button id="goto-resident" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300">
                    我是住戶
                </button>
                <button id="goto-manager" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300">
                    我是管理員
                </button>
            </div>
            <p class="text-xs text-gray-400 text-center mt-6">User ID: <span id="portal-user-id">...</span></p>
        </div>

        <!-- 2. 住戶畫面 -->
        <div id="resident-view" class="hidden">
            <button id="resident-back-btn" class="text-sm text-blue-500 hover:text-blue-700 mb-4">&larr; 返回</button>
            <h1 class="text-2xl font-bold text-center text-green-600 mb-6">住戶服務</h1>
            
            <div class="mb-6">
                <label for="resident-info" class="block text-sm font-medium text-gray-700 mb-2">您的房號或姓名：</label>
                <input type="text" id="resident-info" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="例如：A棟101房 陳先生">
            </div>

            <button id="sos-button" class="w-full h-36 bg-red-600 text-white font-bold text-4xl rounded-2xl shadow-2xl flex items-center justify-center transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:animate-none" disabled>
                SOS<br>緊急呼叫
            </button>
            <p id="resident-status" class="text-center text-gray-500 mt-4 h-6"></p>
        </div>

        <!-- 3. 管理員畫面 -->
        <div id="manager-view" class="hidden">
            <button id="manager-back-btn" class="text-sm text-blue-500 hover:text-blue-700 mb-4">&larr; 返回</button>
            <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">管理中心 - 緊急通報</h1>

            <!-- 設定區塊 (鈴聲設定) -->
            <div class="settings-box">
                <h3 class="font-bold text-gray-700 mb-3">鈴聲設定</h3>
                
                <!-- 鈴聲選擇 -->
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">選擇鈴聲</label>
                    <div class="flex gap-2">
                        <select id="ringtone-select" class="flex-1 border border-gray-300 rounded-md p-2 text-sm bg-white">
                            <option value="alice">預設：愛麗絲 (合成音)</option>
                            <option value="phone">預設：傳統電話聲 (合成音)</option>
                            <!-- 自訂鈴聲會動態插入這裡 -->
                        </select>
                        <button id="preview-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-1 px-3 rounded text-sm transition duration-200 whitespace-nowrap">
                            ▶ 試聽
                        </button>
                    </div>
                </div>

                <!-- 管理/上傳鈴聲區塊 -->
                <div class="mb-3 border-t border-gray-300 pt-3">
                    <p class="text-sm font-medium text-gray-700 mb-2">新增/管理 MP3 鈴聲</p>
                    
                    <!-- 上傳 -->
                    <div class="flex gap-2 items-center mb-2">
                        <input type="file" id="mp3-file-input" accept=".mp3,.wav,audio/mpeg,audio/wav" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <button id="upload-mp3-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm whitespace-nowrap" disabled>上傳</button>
                    </div>
                    <p id="upload-status" class="text-xs text-gray-500 h-4 mb-2"></p>

                    <!-- 鈴聲列表 (可刪除) -->
                    <div id="custom-ringtone-list" class="space-y-1 max-h-24 overflow-y-auto">
                        <!-- 動態產生列表 -->
                    </div>
                </div>

                <!-- 音量控制 -->
                <div class="mb-3">
                    <label for="volume-slider" class="block text-sm font-medium text-gray-700">提示音音量</label>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                </div>

                <!-- 儲存按鈕 -->
                <button id="save-settings-btn" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-4 rounded-lg transition duration-200 text-sm">
                    儲存目前設定 (音量與選擇)
                </button>
                <p id="settings-status" class="text-center text-xs text-gray-500 mt-2 h-4"></p>
            </div>

            <div id="firestore-permission-error" class="error-box hidden w-full mb-4">
                <p class="font-bold text-red-800">Firestore 權限不足</p>
                <p class="text-sm text-red-600 mt-1">無法監聽警報，請檢查規則。</p>
            </div>

            <!-- 警報列表 -->
            <div id="alert-list" class="space-y-3 max-h-80 overflow-y-auto">
                <p id="no-alerts" class="text-gray-500 text-center py-4">目前沒有新的警報。</p>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, getDoc, setDoc, deleteDoc, updateDoc, collection, query, onSnapshot, serverTimestamp, setLogLevel, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- 全域變數 ---
        let db, auth, storage, userId, appId;
        let unsubscribeAlerts = null;
        let unsubscribeRingtones = null;
        let knownAlertIds = new Set();
        
        // 聲音相關
        let audioCtx;
        let currentOscillators = new Set();
        let activeMelodyTimeout = null;
        let isSoundPlaying = false; 
        let isPreviewing = false;
        let mp3Player = new Audio();
        mp3Player.loop = true;

        // 設定與資料
        let currentSettings = {
            selectedRingtoneId: 'alice', // 'alice', 'phone', 或 firestore doc id
            volume: 1
        };
        let customRingtonesMap = new Map(); // ID -> {name, url}

        const firebaseConfig = {
          apiKey: "AIzaSyCslxeIkL0-4FSlQtsnGBRjKEGnIW2NVw8",
          authDomain: "nw-sos.firebaseapp.com",
          projectId: "nw-sos",
          storageBucket: "nw-sos.appspot.com",
          messagingSenderId: "998718068324",
          appId: "1:998718068324:web:cd8b8b69bf043fe64bb171",
          measurementId: "G-E31DVPW0LE"
        };
        
        appId = firebaseConfig.projectId || 'default-app-id';

        // --- DOM ---
        const loadingView = document.getElementById('loading-view');
        const portalView = document.getElementById('portal-view');
        const residentView = document.getElementById('resident-view');
        const managerView = document.getElementById('manager-view');
        
        // Buttons
        document.getElementById('goto-resident').onclick = () => showView('resident');
        document.getElementById('goto-manager').onclick = () => showView('manager');
        document.getElementById('resident-back-btn').onclick = () => showView('portal');
        document.getElementById('manager-back-btn').onclick = () => showView('portal');

        const sosButton = document.getElementById('sos-button');
        const residentInfoInput = document.getElementById('resident-info');
        const residentStatus = document.getElementById('resident-status');
        const alertList = document.getElementById('alert-list');
        const noAlertsMsg = document.getElementById('no-alerts');
        const firestoreError = document.getElementById('firestore-permission-error');

        // Settings DOM
        const ringtoneSelect = document.getElementById('ringtone-select');
        const previewBtn = document.getElementById('preview-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsStatus = document.getElementById('settings-status');
        const mp3FileInput = document.getElementById('mp3-file-input');
        const uploadMp3Btn = document.getElementById('upload-mp3-btn');
        const uploadStatus = document.getElementById('upload-status');
        const customRingtoneList = document.getElementById('custom-ringtone-list');

        // --- 初始化 ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app, 'gs://nw-sos.appspot.com');
                setLogLevel('Silent');

                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('portal-user-id').textContent = userId;
                        sosButton.disabled = false;
                        residentInfoInput.disabled = false;
                        showView('portal');
                    }
                });
            } catch (error) {
                console.error("Init Error:", error);
                document.getElementById('firebase-error-box').classList.remove('hidden');
                document.getElementById('firebase-error-message').textContent = error.message;
            }
        }

        // --- 視圖管理 ---
        function showView(viewName) {
            loadingView.classList.add('hidden');
            portalView.classList.add('hidden');
            residentView.classList.add('hidden');
            managerView.classList.add('hidden');
            firestoreError.classList.add('hidden');

            // Cleanup logic
            if (viewName !== 'manager') {
                if (unsubscribeAlerts) { unsubscribeAlerts(); unsubscribeAlerts = null; }
                if (unsubscribeRingtones) { unsubscribeRingtones(); unsubscribeRingtones = null; }
                knownAlertIds.clear();
                stopAlarm();
            }

            switch (viewName) {
                case 'portal':
                    portalView.classList.remove('hidden');
                    break;
                case 'resident':
                    residentView.classList.remove('hidden');
                    break;
                case 'manager':
                    managerView.classList.remove('hidden');
                    initManagerView();
                    break;
            }
        }

        // --- 管理員功能 ---
        function initManagerView() {
            initAudioContext();
            loadSettings();
            listenForRingtones(); // 監聽自訂鈴聲列表
            listenForAlerts();
        }

        // 1. 監聽自訂鈴聲列表 (Firestore)
        function listenForRingtones() {
            if (unsubscribeRingtones) return;
            
            const q = query(collection(db, `artifacts/${appId}/public/data/custom_ringtones`), orderBy('createdAt', 'desc'));
            
            unsubscribeRingtones = onSnapshot(q, (snapshot) => {
                customRingtoneList.innerHTML = '';
                customRingtonesMap.clear();
                
                // 保留當前選擇 (如果是自訂的)
                const currentVal = ringtoneSelect.value;
                
                // 清空 select 中的自訂選項 (保留前兩個: alice, phone)
                while (ringtoneSelect.options.length > 2) {
                    ringtoneSelect.remove(2);
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    customRingtonesMap.set(id, data);

                    // 添加到下拉選單
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `MP3: ${data.name}`;
                    ringtoneSelect.appendChild(option);

                    // 添加到管理列表 (顯示刪除按鈕)
                    const li = document.createElement('div');
                    li.className = 'flex justify-between items-center bg-white p-2 rounded border border-gray-200 text-xs';
                    li.innerHTML = `
                        <span class="truncate flex-1 mr-2" title="${data.name}">${data.name}</span>
                        <button class="text-red-500 hover:text-red-700 font-bold px-2" data-id="${id}" data-path="${data.storagePath || ''}">刪除</button>
                    `;
                    li.querySelector('button').onclick = (e) => deleteRingtone(e.target.dataset.id, e.target.dataset.path);
                    customRingtoneList.appendChild(li);
                });

                // 恢復選擇 (如果還存在)
                if (currentVal && (currentVal === 'alice' || currentVal === 'phone' || customRingtonesMap.has(currentVal))) {
                    ringtoneSelect.value = currentVal;
                } else {
                    ringtoneSelect.value = 'alice'; // 回退預設
                }
            });
        }

        // 2. 刪除鈴聲
        async function deleteRingtone(docId, storagePath) {
            if (!confirm('確定要刪除這個鈴聲嗎？')) return;
            try {
                // 刪除 Storage 檔案
                if (storagePath) {
                    const fileRef = ref(storage, storagePath);
                    await deleteObject(fileRef).catch(e => console.warn("Storage delete warning:", e));
                }
                // 刪除 Firestore 紀錄
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/custom_ringtones`, docId));
                
                // 如果當前選的是這個，重置為 alice
                if (currentSettings.selectedRingtoneId === docId) {
                    currentSettings.selectedRingtoneId = 'alice';
                    saveSettingsToFirestore(); // 更新資料庫
                }
            } catch (e) {
                console.error("刪除失敗:", e);
                alert("刪除失敗: " + e.message);
            }
        }

        // 3. 上傳新鈴聲
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        mp3FileInput.onchange = () => {
            uploadMp3Btn.disabled = mp3FileInput.files.length === 0;
        };

        uploadMp3Btn.onclick = async () => {
            const file = mp3FileInput.files[0];
            if (!file) return;
            uploadMp3Btn.disabled = true;
            uploadStatus.textContent = '上傳中...';
            uploadStatus.className = 'text-xs text-blue-600 h-4 mb-2';
            try { if (!auth.currentUser) await signInAnonymously(auth); } catch(e) {}
            if (file.size > 700 * 1024) {
                uploadStatus.textContent = '檔案過大，請小於 700KB';
                uploadStatus.className = 'text-xs text-red-600 h-4 mb-2';
                uploadMp3Btn.disabled = false;
                return;
            }
            try {
                const dataUrl = await readFileAsDataURL(file);
                await addDoc(collection(db, `artifacts/${appId}/public/data/custom_ringtones`), {
                    name: file.name,
                    url: dataUrl,
                    createdAt: serverTimestamp()
                });
                uploadStatus.textContent = '上傳成功！';
                uploadStatus.className = 'text-xs text-green-600 h-4 mb-2';
                mp3FileInput.value = '';
            } catch (e) {
                uploadStatus.textContent = '失敗: ' + e.message;
                uploadStatus.className = 'text-xs text-red-600 h-4 mb-2';
            } finally {
                setTimeout(() => { uploadStatus.textContent = ''; }, 3000);
                uploadMp3Btn.disabled = false;
            }
        };

        // 4. 載入設定
        async function loadSettings() {
            const docRef = doc(db, `artifacts/${appId}/public/data/settings/manager_config`);
            const snap = await getDoc(docRef);
            if (snap.exists()) {
                const data = snap.data();
                currentSettings = data;
                // 更新 UI
                volumeSlider.value = data.volume || 1;
                // 延遲設定選單值，確保列表已載入 (或依賴 onSnapshot 的恢復邏輯)
                setTimeout(() => {
                    if (data.selectedRingtoneId) ringtoneSelect.value = data.selectedRingtoneId;
                }, 500);
            }
        }

        // 5. 儲存設定
        async function saveSettingsToFirestore() {
            const newSettings = {
                selectedRingtoneId: ringtoneSelect.value,
                volume: volumeSlider.value
            };
            const docRef = doc(db, `artifacts/${appId}/public/data/settings/manager_config`);
            await setDoc(docRef, newSettings);
            currentSettings = newSettings;
        }

        saveSettingsBtn.onclick = async () => {
            saveSettingsBtn.disabled = true;
            settingsStatus.textContent = '儲存中...';
            try {
                await saveSettingsToFirestore();
                settingsStatus.textContent = '設定已儲存';
                settingsStatus.className = 'text-center text-xs text-green-600 mt-2 h-4';
            } catch (e) {
                settingsStatus.textContent = '錯誤: ' + e.message;
                settingsStatus.className = 'text-center text-xs text-red-600 mt-2 h-4';
            } finally {
                saveSettingsBtn.disabled = false;
                setTimeout(() => settingsStatus.textContent = '', 2000);
            }
        };

        // 6. 試聽功能
        previewBtn.onclick = () => {
            initAudioContext();
            if (isSoundPlaying) {
                stopAlarm();
            } else {
                startPreview();
            }
        };

        function startPreview() {
            const id = ringtoneSelect.value;
            const volume = volumeSlider.value;
            isSoundPlaying = true;
            isPreviewing = true;
            
            previewBtn.textContent = "⏹ 停止";
            previewBtn.classList.replace('bg-purple-500', 'bg-gray-500');
            previewBtn.classList.replace('hover:bg-purple-600', 'hover:bg-gray-600');

            if (id === 'alice') playAlice(volume);
            else if (id === 'phone') playPhoneRing(volume);
            else if (customRingtonesMap.has(id)) {
                playMp3(customRingtonesMap.get(id).url, volume);
            }
        }

        // --- 聲音播放核心 ---
        function initAudioContext() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function stopAlarm() {
            isSoundPlaying = false;
            isPreviewing = false;
            
            previewBtn.textContent = "▶ 試聽";
            previewBtn.classList.replace('bg-gray-500', 'bg-purple-500');
            previewBtn.classList.replace('hover:bg-gray-600', 'hover:bg-purple-600');

            if (activeMelodyTimeout) { clearTimeout(activeMelodyTimeout); activeMelodyTimeout = null; }
            currentOscillators.forEach(osc => { try { osc.stop(); } catch(e){} });
            currentOscillators.clear();
            if (window.speechSynthesis) window.speechSynthesis.cancel();
            mp3Player.pause();
            mp3Player.currentTime = 0;
        }

        function speakAlertText(volume) {
            return new Promise((resolve) => {
                if (!('speechSynthesis' in window) || !isSoundPlaying) return resolve();
                const u = new SpeechSynthesisUtterance("請支援住戶");
                u.lang = 'zh-TW';
                u.volume = parseFloat(volume);
                u.onend = resolve;
                u.onerror = resolve;
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(u);
            });
        }

        async function playAlertSound() {
            if (isSoundPlaying) return;
            isSoundPlaying = true;
            if (audioCtx && audioCtx.state === 'suspended') await audioCtx.resume();

            const volume = volumeSlider.value;
            await speakAlertText(volume); // 先語音

            if (!isSoundPlaying) return;

            const id = currentSettings.selectedRingtoneId || 'alice';
            if (id === 'alice') playAlice(volume);
            else if (id === 'phone') playPhoneRing(volume);
            else if (customRingtonesMap.has(id)) {
                playMp3(customRingtonesMap.get(id).url, volume);
            } else {
                playAlice(volume); // Fallback
            }
        }

        function playMp3(url, volume) {
            mp3Player.src = url;
            mp3Player.volume = volume;
            mp3Player.play().catch(e => console.error("MP3 Play Error:", e));
        }

        // 電話鈴聲
        function playPhoneRing(volume) {
            if (!audioCtx) return;
            function ring() {
                if (!isSoundPlaying) return;
                const now = audioCtx.currentTime;
                createOsc(400, now, 2, volume, 'square');
                createOsc(450, now, 2, volume, 'square');
                activeMelodyTimeout = setTimeout(ring, 3000); 
            }
            ring();
        }

        // 愛麗絲
        function playAlice(volume) {
             if (!audioCtx) return;
             const melody = [
                {f: 659, d: 0.15}, {f: 622, d: 0.15}, {f: 659, d: 0.15}, {f: 622, d: 0.15}, {f: 659, d: 0.15}, 
                {f: 494, d: 0.15}, {f: 587, d: 0.15}, {f: 523, d: 0.15}, {f: 440, d: 0.3}
             ];
             let idx = 0;
             let time = audioCtx.currentTime;
             function next() {
                 if (!isSoundPlaying) return;
                 const note = melody[idx % melody.length];
                 createOsc(note.f, time, note.d, volume, 'sine');
                 time += note.d;
                 idx++;
                 if (time < audioCtx.currentTime) time = audioCtx.currentTime;
                 activeMelodyTimeout = setTimeout(next, (note.d * 1000) - 20);
             }
             next();
        }

        function createOsc(freq, startTime, duration, volume, type) {
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(volume * 0.1, startTime);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(startTime);
                osc.stop(startTime + duration);
                currentOscillators.add(osc);
                osc.onended = () => currentOscillators.delete(osc);
            } catch(e) {}
        }

        // --- 住戶功能 (SOS) ---
        residentInfoInput.addEventListener('input', () => residentStatus.textContent = '');
        sosButton.onclick = async () => {
            if (!residentInfoInput.value.trim()) {
                residentStatus.textContent = '請輸入房號！'; residentStatus.className = 'text-center text-red-500 mt-4 h-6'; return;
            }
            sosButton.disabled = true;
            residentStatus.textContent = '發送中...';
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/sos_alerts`), {
                    residentInfo: residentInfoInput.value.trim(),
                    status: 'new',
                    createdAt: serverTimestamp(),
                    senderId: userId
                });
                residentStatus.textContent = '呼叫已發送！'; residentStatus.className = 'text-center text-green-500 mt-4 h-6';
            } catch (e) {
                residentStatus.textContent = '失敗。'; residentStatus.className = 'text-center text-red-500 mt-4 h-6';
            } finally {
                setTimeout(() => { sosButton.disabled = false; residentStatus.textContent = ''; }, 3000);
            }
        };

        // --- 警報監聽 ---
        function listenForAlerts() {
            if (unsubscribeAlerts) return;
            const q = query(collection(db, `artifacts/${appId}/public/data/sos_alerts`));
            unsubscribeAlerts = onSnapshot(q, (snap) => {
                const alerts = [];
                snap.forEach(d => alerts.push({ id: d.id, ...d.data() }));
                updateAlertList(alerts.filter(a => a.status === 'new').sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
            }, (e) => { if(e.code==='permission-denied') firestoreError.classList.remove('hidden'); });
        }

        function updateAlertList(newAlerts) {
            alertList.innerHTML = '';
            if (newAlerts.length === 0) {
                alertList.innerHTML = '<p id="no-alerts" class="text-gray-500 text-center py-4">目前沒有新的警報。</p>';
                if (!isPreviewing) stopAlarm();
            } else {
                let foundNew = false;
                newAlerts.forEach(a => {
                    addAlertUI(a);
                    if (!knownAlertIds.has(a.id)) { knownAlertIds.add(a.id); foundNew = true; }
                });
                if (foundNew) {
                    if (isPreviewing) stopAlarm();
                    if (!isSoundPlaying) playAlertSound();
                }
            }
        }

        function addAlertUI(alert) {
            const div = document.createElement('div');
            div.className = 'bg-red-100 border border-red-300 rounded-lg p-4 shadow-md';
            div.innerHTML = `
                <p class="text-lg font-bold text-red-800">${alert.residentInfo}</p>
                <p class="text-sm text-red-600">時間: ${alert.createdAt ? new Date(alert.createdAt.seconds * 1000).toLocaleString() : '...'}</p>
                <div class="flex gap-2 mt-4">
                    <button class="silence flex-1 bg-blue-500 text-white font-bold py-2 rounded hover:bg-blue-600">已收到 (靜音)</button>
                    <button class="resolve flex-1 bg-green-500 text-white font-bold py-2 rounded hover:bg-green-600">處理完畢</button>
                </div>`;
            div.querySelector('.silence').onclick = stopAlarm;
            div.querySelector('.resolve').onclick = async () => {
                knownAlertIds.delete(alert.id);
                await updateDoc(doc(db, `artifacts/${appId}/public/data/sos_alerts/${alert.id}`), { status: 'resolved' });
            };
            alertList.appendChild(div);
        }

        initializeFirebase();
    </script>
</body>
</html>


