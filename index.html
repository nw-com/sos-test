<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社區SOS緊急系統</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 基本字型和樣式 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        /* 隱藏/顯示視圖的 class */
        .hidden {
            display: none;
        }
        /* SOS 按鈕的動畫 */
        @keyframes pulse-red {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                opacity: 0.8;
                box-shadow: 0 0 0 20px rgba(239, 68, 68, 0);
            }
        }
        .sos-button-animation {
            animation: pulse-red 2s infinite;
        }
        
        /* 自訂錯誤訊息框樣式 */
        .error-box {
            padding: 1rem;
            border-width: 4px;
            border-color: #ef4444; /* red-500 */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: #fee2e2; /* red-100 */
            text-align: left;
        }
        .error-box-title {
            font-size: 1.125rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #b91c1c; /* red-700 */
            margin-bottom: 0.5rem; /* mb-2 */
        }
        .error-box-content {
            color: #dc2626; /* red-600 */
            font-size: 0.875rem; /* text-sm */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- 主容器 -->
    <div class="w-full max-w-md bg-white rounded-lg shadow-xl p-8">

        <!-- 0. 載入中畫面 (Firebase 登入時) -->
        <div id="loading-view" class="text-center">
            <h2 class="text-xl font-bold text-gray-800">系統載入中...</h2>
            <p class="text-gray-500 mt-2">正在連線至伺服器，請稍候。</p>
        </div>

        <!-- 1. 入口選擇畫面 -->
        <div id="portal-view" class="hidden">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-6">社區SOS緊急系統</h1>
            <p class="text-center text-gray-600 mb-8">請選擇您的身份：</p>
            <div class="space-y-4">
                <button id="show-resident-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300 shadow-md">
                    我是住戶
                </button>
                <button id="show-manager-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300 shadow-md">
                    我是管理員
                </button>
            </div>
            <p class="text-xs text-gray-400 mt-6 text-center">您的用戶ID: <span id="portal-user-id" class="font-mono"></span></p>
        </div>

        <!-- 2. 住戶畫面 -->
        <div id="resident-view" class="hidden">
            <button id="resident-back-btn" class="text-sm text-blue-500 hover:text-blue-700 mb-4">&larr; 返回</button>
            <h1 class="text-2xl font-bold text-center text-green-600 mb-6">住戶SOS呼叫</h1>
            
            <div class="mb-6">
                <label for="resident-info" class="block text-sm font-medium text-gray-700 mb-2">您的房號或姓名：</label>
                <input type="text" id="resident-info" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="例如：A棟101房 陳先生">
            </div>

            <button id="sos-button" class="w-full h-48 bg-red-600 text-white font-bold text-4xl rounded-full shadow-2xl flex items-center justify-center transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:animate-none" disabled>
                SOS
            </button>
            <p id="resident-status" class="text-center text-gray-500 mt-4 h-6"></p>
        </div>

        <!-- 3. 管理員畫面 -->
        <div id="manager-view" class="hidden">
            <button id="manager-back-btn" class="text-sm text-blue-500 hover:text-blue-700 mb-4">&larr; 返回</button>
            <h1 class="text-2xl font-bold text-center text-red-600 mb-6">管理中心 - 緊急通報</h1>
            
            <!-- 修正：Firestore 權限錯誤的提示框 -->
            <div id="firestore-error-box" class="hidden error-box mb-4">
                <h3 class="error-box-title">資料庫讀取失敗</h3>
                <p id="firestore-error-content" class="error-box-content"></p>
            </div>

            <div id="alert-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- SOS 警報會動態插入到這裡 -->
                <p id="no-alerts" class="text-gray-500 text-center py-4">目前沒有新的警報。</p>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, collection, query, where, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域變數 ---
        let db, auth, userId, appId;
        let unsubscribeAlerts = null; // 用於儲存 onSnapshot 的取消訂閱函數
        let knownAlertIds = new Set(); // 儲存已知的 'new' 警報ID，用於播放聲音

        // 修正：直接使用用戶提供的 Firebase 金鑰
        const firebaseConfig = {
          apiKey: "AIzaSyCslxeIkL0-4FSlQtsnGBRjKEGnIW2NVw8",
          authDomain: "nw-sos.firebaseapp.com",
          projectId: "nw-sos",
          storageBucket: "nw-sos.firebasestorage.app",
          messagingSenderId: "998718068324",
          appId: "1:998718068324:web:cd8b8b69bf043fe64bb171",
          measurementId: "G-E31DVPW0LE"
        };
        
        // 修正：使用 projectId 作為資料庫路徑的 appId，以確保一致性
        appId = firebaseConfig.projectId;


        // 取得所有視圖和按鈕的 DOM 節點
        const loadingView = document.getElementById('loading-view');
        const portalView = document.getElementById('portal-view');
        const residentView = document.getElementById('resident-view');
        const managerView = document.getElementById('manager-view');
        const portalUserId = document.getElementById('portal-user-id');
        const firestoreErrorBox = document.getElementById('firestore-error-box');
        const firestoreErrorContent = document.getElementById('firestore-error-content');
        
        const showResidentBtn = document.getElementById('show-resident-btn');
        const showManagerBtn = document.getElementById('show-manager-btn');
        const residentBackBtn = document.getElementById('resident-back-btn');
        const managerBackBtn = document.getElementById('manager-back-btn');
        
        const sosButton = document.getElementById('sos-button');
        const residentInfoInput = document.getElementById('resident-info');
        const residentStatus = document.getElementById('resident-status');
        const alertList = document.getElementById('alert-list');
        const noAlertsMsg = document.getElementById('no-alerts');

        // --- 1. 初始化與 Firebase 認證 ---

        async function initializeFirebase() {
            try {
                // 1. 初始化 Firebase App
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 設定日誌級別以便調試
                setLogLevel('Debug');

                // 2. 監聽認證狀態
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // 使用者已登入
                        userId = user.uid;
                        portalUserId.textContent = userId.substring(0, 8) + '...';
                        console.log("Firebase 認證成功, User ID:", userId);
                        
                        // 顯示入口畫面
                        showView('portal');
                    } else {
                        // 使用者未登入，執行登入
                        console.log("使用者未登入，嘗試使用 token 或匿名登入...");
                        await signInUser();
                    }
                });
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                loadingView.innerHTML = `<p class="text-red-500">Firebase 初始化失敗: ${error.message}</p>`;
            }
        }

        async function signInUser() {
            try {
                // 修正：當使用自訂的 firebaseConfig 時，強制使用匿名登入
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase 登入失敗:", error);
                
                // 提供更具體的錯誤訊息給使用者
                let userErrorMessage = `Firebase 登入失敗: ${error.message}`;
                if (error.code === 'auth/configuration-not-found') {
                    userErrorMessage = '<b>Firebase 登入失敗 (auth/configuration-not-found):</b> <br>請檢查您的 Firebase 專案設定。<br>1. 確認 `firebaseConfig` 拼寫正確。<br>2. <b>重要：</b>請前往 Firebase Console &gt; Authentication &gt; Sign-in method (登入方式)，並<b>啟用「匿名 (Anonymous)」</b>登入。';
                } else if (error.code === 'auth/custom-token-mismatch') {
                     userErrorMessage = '<b>Firebase 登入失敗 (auth/custom-token-mismatch):</b> <br>偵測到自訂金鑰，但環境 token 不符。已嘗試切換至匿名登入，但可能失敗。';
                
                } else if (error.code === 'auth/admin-restricted-operation') {
                    userErrorMessage = '<b>Firebase 登入失敗 (auth/admin-restricted-operation):</b> <br>此操作已被管理員限制。請檢查：<br>1. <b>(最可能)</b> 請再次確認您已在 Firebase Console &gt; Authentication &gt; Sign-in method 中<b>啟用「匿名 (Anonymous)」</b>登入。<br>2. <b>(其次可能)</b> 您可能設定了 API 金鑰限制。請前往 Google Cloud Console &gt; APIs & 服務 &gt; 憑證，找到您的 API 金鑰。如果您設定了 "HTTP 參照網址" (HTTP referrers)，請確保已將 `*.scf.usercontent.goog` 加入允許清單，或暫時移除所有限制。';
                
                }
                
                // 修正：讓錯誤訊息更明顯
                loadingView.innerHTML = `<div class="error-box">
                    <h3 class="error-box-title">發生錯誤</h3>
                    <p class="error-box-content">${userErrorMessage}</p>
                </div>`;
            }
        }

        // --- 2. 視圖管理 ---

        function showView(viewName) {
            // 先隱藏所有視圖
            loadingView.classList.add('hidden');
            portalView.classList.add('hidden');
            residentView.classList.add('hidden');
            managerView.classList.add('hidden');
            
            // 修正：隱藏 Firestore 錯誤框
            firestoreErrorBox.classList.add('hidden');

            // 取消訂閱舊的監聽器
            if (viewName !== 'manager' && unsubscribeAlerts) {
                console.log("離開管理頁面，取消監聽。");
                unsubscribeAlerts();
                unsubscribeAlerts = null;
                knownAlertIds.clear(); // 重置已知的警報
            }

            // 顯示指定的視圖
            switch (viewName) {
                case 'portal':
                    portalView.classList.remove('hidden');
                    break;
                case 'resident':
                    residentView.classList.remove('hidden');
                    break;
                case 'manager':
                    managerView.classList.remove('hidden');
                    // 進入管理頁面時，開始監聽
                    listenForAlerts();
                    break;
                case 'loading':
                    loadingView.classList.remove('hidden');
                    break;
            }
        }

        // 綁定入口按鈕事件
        showResidentBtn.addEventListener('click', () => showView('resident'));
        showManagerBtn.addEventListener('click', () => {
            // S首次進入管理頁面時，主動觸發一次空的語音，以獲取瀏覽器音訊權限
            try {
                const primer = new SpeechSynthesisUtterance(' ');
                primer.volume = 0; // 靜音播放
                speechSynthesis.speak(primer);
            } catch (e) {
                console.warn("無法預熱語音引擎:", e.message);
            }
            showView('manager');
        });
        residentBackBtn.addEventListener('click', () => showView('portal'));
        managerBackBtn.addEventListener('click', () => showView('portal'));

        // --- 3. 住戶邏輯 ---

        // 根據輸入框內容啟用/禁用SOS按鈕
        residentInfoInput.addEventListener('input', () => {
            if (residentInfoInput.value.trim() !== '') {
                sosButton.disabled = false;
                if (!sosButton.classList.contains('sos-button-animation')) {
                     sosButton.classList.add('sos-button-animation');
                }
            } else {
                sosButton.disabled = true;
                sosButton.classList.remove('sos-button-animation');
            }
        });

        // 發送SOS
        sosButton.addEventListener('click', async () => {
            const info = residentInfoInput.value.trim();
            if (!info || !userId) return;

            // 暫時禁用按鈕
            sosButton.disabled = true;
            sosButton.classList.remove('sos-button-animation');
            residentStatus.textContent = '正在發送訊號...';

            try {
                // 儲存到 public 集合中，讓管理員能看到
                const collectionRef = collection(db, `artifacts/${appId}/public/data/sos_alerts`);
                await addDoc(collectionRef, {
                    residentId: userId,
                    residentInfo: info,
                    status: 'new', // 狀態：new, acknowledged, resolved
                    timestamp: serverTimestamp()
                });

                residentStatus.textContent = '訊號已發送！管理中心將盡速處理。';
                residentInfoInput.value = ''; // 清空輸入框
                
                // 5秒後重新啟用按鈕
                setTimeout(() => {
                    residentStatus.textContent = '';
                    // 重新檢查輸入框
                    if (residentInfoInput.value.trim() !== '') {
                        sosButton.disabled = false;
                        sosButton.classList.add('sos-button-animation');
                    }
                }, 5000);

            } catch (error) {
                console.error("發送 SOS 失敗:", error);
                residentStatus.textContent = `發送失敗: ${error.message}`;
                sosButton.disabled = false; // 失敗了，允許重試
                sosButton.classList.add('sos-button-animation');
            }
        });

        // --- 4. 管理員邏輯 ---

        // 播放提示音
        function playAlertSound() {
            try {
                const utterance = new SpeechSynthesisUtterance("請支援住戶");
                utterance.lang = 'zh-TW'; // 指定語言
                utterance.rate = 1.1; // 稍快語速
                utterance.pitch = 1.2; // 稍高音調
                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error("播放提示音失敗:", error);
            }
        }

        // 監聽新的警報
        function listenForAlerts() {
            if (!db) return;
            
            // 監聽整個集合，繞過 'where' 查詢可能需要的索引
            const collectionRef = collection(db, `artifacts/${appId}/public/data/sos_alerts`);

            unsubscribeAlerts = onSnapshot(collectionRef, (snapshot) => {
                
                let currentNewAlerts = new Map(); // 當前所有 'new' 警報
                snapshot.docs.forEach(doc => {
                    if (doc.data().status === 'new') {
                        currentNewAlerts.set(doc.id, { ...doc.data(), id: doc.id });
                    }
                });

                // 檢查是否有 *新* 加入的 'new' 警報 (用於播放聲音)
                snapshot.docChanges().forEach((change) => {
                    const docId = change.doc.id;
                    const docData = change.doc.data();
                    
                    if (docData.status === 'new') {
                        // 如果這個警報是 'new' 且我們 *之前不知道* 它是 'new'
                        if (!knownAlertIds.has(docId)) {
                            if (change.type === 'added' || (change.type === 'modified')) {
                                console.log("新警報或狀態變為 new:", docId);
                                playAlertSound();
                                knownAlertIds.add(docId); // 記住它
                            }
                        }
                    } else {
                        // 如果這個警報 *不再* 是 'new'
                        if (knownAlertIds.has(docId)) {
                            knownAlertIds.delete(docId); // 從 "已知" 中移除
                        }
                    }
                });

                // --- 重新渲染UI ---
                alertList.innerHTML = ''; // 清空列表

                if (currentNewAlerts.size === 0) {
                    noAlertsMsg.classList.remove('hidden');
                } else {
                    noAlertsMsg.classList.add('hidden');
                    
                    // 排序 (最新的在最上面)
                    const sortedAlerts = Array.from(currentNewAlerts.values()).sort((a, b) => {
                        const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                        const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                        return timeB - timeA; // 降序
                    });

                    // 重新產生所有 UI 元素
                    sortedAlerts.forEach(alertData => {
                        addAlertToUI(alertData, alertData.id);
                    });
                }

            }, (error) => {
                console.error("監聽警報失敗:", error);
                
                // 修正：在管理員介面顯示 Firestore 權限錯誤
                if (error.code === 'permission-denied' || error.message.includes('permission')) {
                    firestoreErrorContent.innerHTML = '<b>(Error: Missing or insufficient permissions.)</b><br>這表示您的 Firebase 安全性規則阻止了程式讀取資料。<br><br><b>解決方案：</b><br>1. 前往您的 Firebase 專案 (`nw-sos`)。<br>2. 選擇 "Firestore Database"。<br>3. 點選 "規則 (Rules)" 頁籤。<br>4. 將規則修改為允許讀取（例如 `allow read: if true;`）並發布。';
                    firestoreErrorBox.classList.remove('hidden');
                } else {
                    firestoreErrorContent.textContent = `無法載入警報: ${error.message}`;
                    firestoreErrorBox.classList.remove('hidden');
                }
                
                alertList.innerHTML = ''; // 清空列表
                noAlertsMsg.classList.remove('hidden'); // 顯示 "無警報"
            });
        }

        // 將警報添加到UI
        function addAlertToUI(data, docId) {
            noAlertsMsg.classList.add('hidden'); // 隱藏 "無警報" 訊息

            const alertTime = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : '時間未知';
            
            const alertElement = document.createElement('div');
            alertElement.id = `alert-${docId}`;
            alertElement.className = "bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md flex justify-between items-center";
            
            alertElement.innerHTML = `
                <div>
                    <p class="font-bold text-lg">${data.residentInfo}</p>
                    <p class="text-sm">${alertTime}</p>
                </div>
                <button data-doc-id="${docId}" class="resolve-btn bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                    處理完畢
                </button>
            `;
            
            // 將最新的警報放在最上面
            alertList.prepend(alertElement);

            // 綁定 "處理完畢" 按鈕事件
            alertElement.querySelector('.resolve-btn').addEventListener('click', () => {
                resolveAlert(docId);
            });
        }

        // 從UI移除警報
        function removeAlertFromUI(docId) {
            const alertElement = document.getElementById(`alert-${docId}`);
            if (alertElement) {
                alertElement.remove();
            }

            // 檢查是否所有警報都已移除
            if (alertList.querySelectorAll('div').length === 0) {
                noAlertsMsg.classList.remove('hidden');
            }
        }

        // 處理警報 (將狀態更新為 'resolved')
        async function resolveAlert(docId) {
            try {
                const docRef = doc(db, `artifacts/${appId}/public/data/sos_alerts`, docId);
                await updateDoc(docRef, {
                    status: 'resolved' // 狀態改為已處理
                });
                // onSnapshot 會自動偵測到這個變更並從UI移除
                console.log(`警報 ${docId} 已處理`);
            } catch (error) {
                console.error("處理警報失敗:", error);
            }
        }

        // --- 5. 啟動應用程式 ---
        initializeFirebase();

    </script>
</body>
</html>
