<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社區SOS緊急系統</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 自訂樣式 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        /* 載入中... 的動畫 */
        .spinner {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* SOS 按鈕的呼吸效果 */
        #sos-button:not(:disabled) {
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
        }
        /* 錯誤提示框 */
        .error-box {
            background-color: #fef2f2; /* red-50 */
            border: 1px solid #fecaca; /* red-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
            margin-top: 1rem; /* mt-4 */
        }
        .error-box-title {
            color: #991b1b; /* red-800 */
            font-weight: 600; /* font-semibold */
        }
        .error-box-content {
            color: #dc2626; /* red-600 */
            font-size: 0.875rem; /* text-sm */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- 容器 -->
    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 md:p-8">

        <!-- 0. 載入中畫面 -->
        <div id="loading-view">
            <div class="flex flex-col items-center justify-center min-h-[200px]">
                <div class="spinner w-12 h-12 border-4 border-gray-200 rounded-full"></div>
                <p id="loading-text" class="text-gray-500 mt-4">系統載入中...</p>
                <!-- Firebase 錯誤提示區 -->
                <div id="firebase-error-box" class="error-box hidden w-full">
                    <p class="error-box-title">Firebase 連線失敗</p>
                    <p id="firebase-error-message" class="error-box-content mt-2"></p>
                    <p id="firebase-error-solution" class="error-box-content mt-1"></p>
                </div>
            </div>
        </div>

        <!-- 1. 入口選擇畫面 -->
        <div id="portal-view" class="hidden">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">社區SOS系統</h1>
            <div class="space-y-4">
                <button id="goto-resident" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300">
                    我是住戶
                </button>
                <button id="goto-manager" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg text-lg transition duration-300">
                    我是管理員
                </button>
            </div>
            <p class="text-xs text-gray-400 text-center mt-6">User ID: <span id="portal-user-id">...</span></p>
        </div>

        <!-- 2. 住戶畫面 -->
        <div id="resident-view" class="hidden">
            <button id="resident-back-btn" class="text-sm text-blue-500 hover:text-blue-700 mb-4">&larr; 返回</button>
            <h1 class="text-2xl font-bold text-center text-green-600 mb-6">住戶服務</h1>
            
            <div class="mb-6">
                <label for="resident-info" class="block text-sm font-medium text-gray-700 mb-2">您的房號或姓名：</label>
                <input type="text" id="resident-info" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="例如：A棟101房 陳先生">
            </div>

            <button id="sos-button" class="w-full h-36 bg-red-600 text-white font-bold text-4xl rounded-2xl shadow-2xl flex items-center justify-center transition duration-300 ease-in-out transform hover:scale-105 disabled:opacity-50 disabled:animate-none" disabled>
                SOS<br>緊急呼叫
            </button>
            <p id="resident-status" class="text-center text-gray-500 mt-4 h-6"></p>
        </div>

        <!-- 3. 管理員畫面 -->
        <div id="manager-view" class="hidden">
            <button id="manager-back-btn" class="text-sm text-blue-500 hover:text-blue-700 mb-4">&larr; 返回</button>
            <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">管理中心 - 緊急通報</h1>

            <!-- 音量控制 -->
            <div class="mb-4">
                <label for="volume-slider" class="block text-sm font-medium text-gray-700">提示音音量</label>
                <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- Firestore 權限錯誤提示 -->
            <div id="firestore-permission-error" class="error-box hidden w-full">
                <p class="error-box-title">Firestore 權限不足</p>
                <p class="error-box-content mt-2">
                    無法監聽警報。這通常是因為您的 Firebase 安全規則 (Rules) 不允許讀取。
                </p>
                <p class="error-box-content mt-1">
                    <b>解決方案：</b>請登入您的 Firebase 專案 (`nw-sos`)，前往 <b>Firestore Database -> 規則 (Rules)</b> 頁籤，並貼上推薦的安全規則。
                </p>
            </div>

            <!-- 警報列表 -->
            <div id="alert-list" class="space-y-3 max-h-96 overflow-y-auto">
                <!-- SOS 警報會動態插入到這裡 -->
                <p id="no-alerts" class="text-gray-500 text-center py-4">目前沒有新的警報。</p>
            </div>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, collection, query, where, onSnapshot, serverTimestamp, setLogLevel, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域變數 ---
        let db, auth, userId, appId;
        let unsubscribeAlerts = null; // 用於儲存 onSnapshot 的取消訂閱函數
        let knownAlertIds = new Set(); // 儲存已知的 'new' 警報ID，用於播放聲音
        
        // --- 聲音相關全域變數 ---
        let audioCtx; // AudioContext
        let currentOscillators = new Set(); // 儲存目前播放的音符
        let activeMelodyTimeout = null; // 追蹤遞迴的 Timeout
        let isSoundPlaying = false; // 用於防止聲音重疊

        // 修正：直接使用用戶提供的 Firebase 金鑰
        const firebaseConfig = {
          apiKey: "AIzaSyCslxeIkL0-4FSlQtsnGBRjKEGnIW2NVw8",
          authDomain: "nw-sos.firebaseapp.com",
          projectId: "nw-sos",
          storageBucket: "nw-sos.firebasestorage.app",
          messagingSenderId: "998718068324",
          appId: "1:998718068324:web:cd8b8b69bf043fe64bb171",
          measurementId: "G-E31DVPW0LE"
        };
        
        // 修正：使用 projectId 作為 appId
        appId = firebaseConfig.projectId || 'default-app-id';

        // --- DOM 節點 ---
        const loadingView = document.getElementById('loading-view');
        const loadingText = document.getElementById('loading-text');
        const errorBox = document.getElementById('firebase-error-box');
        const errorMessage = document.getElementById('firebase-error-message');
        const errorSolution = document.getElementById('firebase-error-solution');

        const portalView = document.getElementById('portal-view');
        const portalUserId = document.getElementById('portal-user-id');
        const residentView = document.getElementById('resident-view');
        const managerView = document.getElementById('manager-view');
        
        const gotoResidentBtn = document.getElementById('goto-resident');
        const gotoManagerBtn = document.getElementById('goto-manager');
        const residentBackBtn = document.getElementById('resident-back-btn');
        const managerBackBtn = document.getElementById('manager-back-btn');

        const sosButton = document.getElementById('sos-button');
        const residentInfoInput = document.getElementById('resident-info');
        const residentStatus = document.getElementById('resident-status');
        const alertList = document.getElementById('alert-list');
        const noAlertsMsg = document.getElementById('no-alerts');
        const volumeSlider = document.getElementById('volume-slider');
        const firestoreError = document.getElementById('firestore-permission-error');


        // --- 1. 初始化與 Firebase 認證 ---

        async function initializeFirebase() {
            try {
                // 1. 初始化 Firebase App
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 設定日誌級別以便調試
                setLogLevel('Debug');

                // 2. 登入用戶
                await signInUser();

                // 3. 監聽認證狀態
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Firebase 認證成功, User ID:", user.uid);
                        userId = user.uid;
                        portalUserId.textContent = userId;
                        // 啟用住戶頁面的按鈕
                        sosButton.disabled = false;
                        residentInfoInput.disabled = false;
                        // 顯示入口
                        showView('portal');
                    } else {
                        console.log("用戶未登入。");
                        userId = null;
                        sosButton.disabled = true;
                        residentInfoInput.disabled = true;
                    }
                });

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                showFirebaseError("Firebase 初始化失敗", error);
            }
        }

        async function signInUser() {
            try {
                // 強制使用匿名登入
                console.log("嘗試匿名登入...");
                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase 登入失敗:", error);
                showFirebaseError("Firebase 登入失敗", error);
            }
        }
        
        // 顯示更詳細的 Firebase 錯誤
        function showFirebaseError(title, error) {
            loadingText.textContent = title;
            errorMessage.textContent = `錯誤: ${error.message} (代碼: ${error.code})`;

            // 針對特定錯誤提供解決方案
            if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation') {
                errorSolution.innerHTML = `<b>解決方案：</b>請登入您的 Firebase 專案，前往 <b>Authentication -> Sign-in method</b>，並**啟用「匿名 (Anonymous)」**登入。`;
            } else {
                errorSolution.textContent = "請檢查您的網路連線或 Firebase 金鑰設定。";
            }
            errorBox.classList.remove('hidden');
        }

        // --- 2. 視圖管理 ---

        function showView(viewName) {
            // 先隱藏所有視圖
            loadingView.classList.add('hidden');
            portalView.classList.add('hidden');
            residentView.classList.add('hidden');
            managerView.classList.add('hidden');
            
            // 修正：隱藏 Firestore 錯誤框
            firestoreError.classList.add('hidden');

            // 如果離開管理頁面，停止監聽
            if (viewName !== 'manager' && unsubscribeAlerts) {
                console.log("離開管理頁面，取消監聽。");
                unsubscribeAlerts();
                unsubscribeAlerts = null;
                knownAlertIds.clear(); 
                stopAlarm(); // 離開頁面時停止聲音
            }

            // 顯示指定的視圖
            switch (viewName) {
                case 'portal':
                    portalView.classList.remove('hidden');
                    break;
                case 'resident':
                    residentView.classList.remove('hidden');
                    break;
                case 'manager':
                    managerView.classList.remove('hidden');
                    // 進入管理頁面時，開始監聽
                    listenForAlerts();
                    break;
            }
        }

        // 綁定視圖切換按鈕
        gotoResidentBtn.addEventListener('click', () => showView('resident'));
        gotoManagerBtn.addEventListener('click', () => showView('manager'));
        residentBackBtn.addEventListener('click', () => showView('portal'));
        managerBackBtn.addEventListener('click', () => showView('portal'));

        // --- 3. 住戶功能 (發送SOS) ---

        residentInfoInput.addEventListener('input', () => {
            residentStatus.textContent = ''; // 清除狀態
        });

        sosButton.addEventListener('click', async () => {
            const info = residentInfoInput.value.trim();
            if (!info) {
                residentStatus.textContent = '請先輸入您的房號或姓名！';
                residentStatus.classList.add('text-red-500');
                return;
            }

            // 禁用按鈕
            sosButton.disabled = true;
            residentStatus.textContent = '正在發送緊急呼叫...';
            residentStatus.classList.remove('text-red-500');
            residentStatus.classList.add('text-gray-500');

            try {
                // 資料庫路徑
                const collectionPath = `artifacts/${appId}/public/data/sos_alerts`;
                
                // 新增文件
                const docRef = await addDoc(collection(db, collectionPath), {
                    residentInfo: info,
                    status: 'new', // new, resolved
                    createdAt: serverTimestamp(),
                    senderId: userId
                });

                console.log("SOS 發送成功, Doc ID:", docRef.id);
                residentStatus.textContent = '緊急呼叫已發送！';
                residentStatus.classList.add('text-green-500');

            } catch (error) {
                console.error("SOS 發送失敗:", error);
                residentStatus.textContent = '發送失敗，請稍後再試。';
                residentStatus.classList.add('text-red-500');
            } finally {
                // 3秒後重新啟用按鈕
                setTimeout(() => {
                    sosButton.disabled = false;
                    residentStatus.textContent = '';
                    residentStatus.classList.remove('text-green-500', 'text-red-500');
                }, 3000);
            }
        });

        // --- 4. 管理員功能 (接收SOS) ---

        function listenForAlerts() {
            if (unsubscribeAlerts) {
                console.log("監聽器已在執行中。");
                return;
            }

            console.log("開始監聽警報...");
            firestoreError.classList.add('hidden'); // 重置錯誤提示
            
            const collectionPath = `artifacts/${appId}/public/data/sos_alerts`;

            const q = query(collection(db, collectionPath));

            unsubscribeAlerts = onSnapshot(q, (querySnapshot) => {
                console.log("收到資料更新");
                const alerts = [];
                querySnapshot.forEach((doc) => {
                    alerts.push({ id: doc.id, ...doc.data() });
                });

                // 在客戶端手動過濾和排序
                const newAlerts = alerts
                    .filter(a => a.status === 'new')
                    .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); // 最新的在前面

                updateAlertList(newAlerts);

            }, (error) => {
                console.error("監聽警報失敗:", error);
                // 檢查是否為權限錯誤
                if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                    firestoreError.classList.remove('hidden');
                }
            });
        }

        function updateAlertList(newAlerts) {
            alertList.innerHTML = ''; // 清空列表

            if (newAlerts.length === 0) {
                alertList.appendChild(noAlertsMsg);
                noAlertsMsg.classList.remove('hidden');
                // 如果沒有警報了，確保停止聲音
                stopAlarm(); 
            } else {
                noAlertsMsg.classList.add('hidden');
                let newAlertFound = false;

                newAlerts.forEach(alert => {
                    addAlertToUI(alert);
                    
                    // 檢查這是否是一個新的、之前未知的警報
                    if (!knownAlertIds.has(alert.id)) {
                        console.log("偵測到新警報:", alert.id);
                        knownAlertIds.add(alert.id);
                        newAlertFound = true;
                    }
                });

                // 如果有新警報，且目前沒有聲音在播放
                if (newAlertFound && !isSoundPlaying) {
                    playAlertSound();
                }
            }
        }

        function addAlertToUI(alert) {
            const alertEl = document.createElement('div');
            alertEl.id = `alert-${alert.id}`;
            alertEl.className = 'bg-red-100 border border-red-300 rounded-lg p-4 shadow-md';

            const info = document.createElement('p');
            info.className = 'text-lg font-bold text-red-800';
            info.textContent = alert.residentInfo;

            const time = document.createElement('p');
            time.className = 'text-sm text-red-600';
            time.textContent = `時間: ${alert.createdAt ? new Date(alert.createdAt.seconds * 1000).toLocaleString() : '...'}`;
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-wrap gap-2 mt-4'; // 使用 flex-wrap 和 gap

            // --- 「已收到 (靜音)」按鈕 ---
            const silenceBtn = document.createElement('button');
            silenceBtn.className = 'flex-auto bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200';
            silenceBtn.textContent = '已收到 (靜音)';
            silenceBtn.onclick = () => {
                console.log("按下靜音");
                stopAlarm(); // 呼叫停止警報
            };

            const resolveBtn = document.createElement('button');
            resolveBtn.className = 'flex-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200';
            resolveBtn.textContent = '處理完畢';
            
            resolveBtn.addEventListener('click', async () => {
                try {
                    resolveBtn.disabled = true;
                    resolveBtn.textContent = '處理中...';
                    
                    // 將此警報 ID 從 knownAlertIds 移除，以便下次能再次觸發
                    knownAlertIds.delete(alert.id);
                    
                    const docPath = `artifacts/${appId}/public/data/sos_alerts/${alert.id}`;
                    await updateDoc(doc(db, docPath), {
                        status: 'resolved'
                    });

                    // onSnapshot 會自動處理 UI 更新
                    
                } catch (error) {
                    console.error("更新狀態失敗:", error);
                    resolveBtn.disabled = false;
                    resolveBtn.textContent = '處理完畢';
                    // 顯示錯誤
                }
            });

            buttonContainer.appendChild(silenceBtn);
            buttonContainer.appendChild(resolveBtn);
            alertEl.appendChild(info);
            alertEl.appendChild(time);
            alertEl.appendChild(buttonContainer);

            alertList.appendChild(alertEl);
        }

        // --- 5. 聲音播放功能 ---

        // 初始化 AudioContext
        function initAudioContext() {
            if (!audioCtx) {
                try {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    console.log("AudioContext 已初始化");
                } catch (e) {
                    console.error("Web Audio API 不支援。", e);
                }
            }
        }
        // 在管理員按鈕點擊時初始化
        gotoManagerBtn.addEventListener('click', initAudioContext);

        // --- 強制停止所有警報 ---
        function stopAlarm() {
            console.log("停止所有警報聲音...");
            isSoundPlaying = false; // 重設標記

            // 停止遞迴的 Timeout
            if (activeMelodyTimeout) {
                clearTimeout(activeMelodyTimeout);
                activeMelodyTimeout = null;
            }

            // 停止所有正在播放的音符
            currentOscillators.forEach(osc => {
                try { osc.stop(); } catch(e) {}
            });
            currentOscillators.clear();

            // 停止語音
            if (window.speechSynthesis) {
                window.speechSynthesis.cancel();
            }
        }

        // *** 修改：播放《快樂頌》，單次超過1分鐘 ***
        function playRingTone(volume) {
            if (!audioCtx) {
                console.warn("AudioContext 未初始化，無法播放鈴聲。");
                return;
            }
            if (!isSoundPlaying) return; // 如果在呼叫時已經被停止
            
            // 音符頻率 (Hz)
            const C4 = 261.63, D4 = 293.66, E4 = 329.63, F4 = 349.23, G4 = 392.00, A4 = 440.00, B4 = 493.88;
            const R = 0; // 休止符
            
            // 拍子長度 (秒)，設定 60 BPM (每拍 1 秒)
            const quarter = 1.0; // 四分音符
            const half = 2.0;    // 二分音符
            const dotted_quarter = 1.5; // 附點四分音符
            const eighth = 0.5;  // 八分音符

            // 貝多芬《快樂頌》 (Ode to Joy) - 主旋律 (AABA)
            // 總共 16 小節 * 4 拍/小節 = 64 拍
            // @ 60 BPM = 64 秒
            const melody = [
                // A 部 (小節 1-4)
                { freq: E4, duration: quarter }, { freq: E4, duration: quarter }, { freq: F4, duration: quarter }, { freq: G4, duration: quarter },
                { freq: G4, duration: quarter }, { freq: F4, duration: quarter }, { freq: E4, duration: quarter }, { freq: D4, duration: quarter },
                { freq: C4, duration: quarter }, { freq: C4, duration: quarter }, { freq: D4, duration: quarter }, { freq: E4, duration: quarter },
                { freq: E4, duration: dotted_quarter }, { freq: D4, duration: eighth }, { freq: D4, duration: half }, // 第4小節
                
                // A 部 (小節 5-8)
                { freq: E4, duration: quarter }, { freq: E4, duration: quarter }, { freq: F4, duration: quarter }, { freq: G4, duration: quarter },
                { freq: G4, duration: quarter }, { freq: F4, duration: quarter }, { freq: E4, duration: quarter }, { freq: D4, duration: quarter },
                { freq: C4, duration: quarter }, { freq: C4, duration: quarter }, { freq: D4, duration: quarter }, { freq: E4, duration: quarter },
                { freq: D4, duration: dotted_quarter }, { freq: C4, duration: eighth }, { freq: C4, duration: half }, // 第8小節

                // B 部 (小節 9-12)
                { freq: D4, duration: quarter }, { freq: D4, duration: quarter }, { freq: E4, duration: quarter }, { freq: C4, duration: quarter },
                { freq: D4, duration: quarter }, { freq: E4, duration: eighth }, { freq: F4, duration: eighth }, { freq: E4, duration: quarter }, { freq: C4, duration: quarter },
                { freq: D4, duration: quarter }, { freq: E4, duration: eighth }, { freq: F4, duration: eighth }, { freq: E4, duration: quarter }, { freq: D4, duration: quarter },
                { freq: C4, duration: quarter }, { freq: D4, duration: quarter }, { freq: G4, duration: half }, // 第12小節

                // A 部 (小節 13-16)
                { freq: E4, duration: quarter }, { freq: E4, duration: quarter }, { freq: F4, duration: quarter }, { freq: G4, duration: quarter },
                { freq: G4, duration: quarter }, { freq: F4, duration: quarter }, { freq: E4, duration: quarter }, { freq: D4, duration: quarter },
                { freq: C4, duration: quarter }, { freq: C4, duration: quarter }, { freq: D4, duration: quarter }, { freq: E4, duration: quarter },
                { freq: D4, duration: dotted_quarter }, { freq: C4, duration: eighth }, { freq: C4, duration: half } // 第16小節
            ];
            
            let noteIndex = 0;
            let startTime = audioCtx.currentTime;

            function playNextNote() {
                // 如果中途被 stopAlarm() 停止，則中斷循環
                if (!isSoundPlaying) return; 

                //  modulo 實現無限循環
                const note = melody[noteIndex % melody.length];
                const noteStartTime = startTime;
                
                // 播放音符
                playNote(note.freq, noteStartTime, note.duration, volume);
                
                // 準備下一個音符的時間
                startTime += note.duration;
                noteIndex++;

                // 設置遞迴
                if (audioCtx.currentTime > startTime) {
                    startTime = audioCtx.currentTime;
                }
                
                activeMelodyTimeout = setTimeout(playNextNote, (note.duration * 1000) - 50); // 稍微提早，保持節奏
            }

            playNextNote(); // 啟動無限循環
        }

        // 輔助函數：播放單個音符
        function playNote(frequency, startTime, duration, volume) {
            if (frequency === 0) return; // 處理休止符
            if (!audioCtx || audioCtx.state === 'closed') {
                if (audioCtx) console.warn("AudioContext is closed, re-initializing.");
                initAudioContext(); // 嘗試重新初始化
                if (!audioCtx) return;
            }
            try {
                const gainNode = audioCtx.createGain();
                gainNode.gain.setValueAtTime(volume * 0.5, startTime); 
                gainNode.gain.linearRampToValueAtTime(0.001, startTime + duration * 0.9); // 避免 0
                gainNode.connect(audioCtx.destination);

                const oscillator = audioCtx.createOscillator();
                oscillator.type = 'sine'; // 優美的正弦波
                oscillator.frequency.setValueAtTime(frequency, startTime);
                oscillator.connect(gainNode);
                
                oscillator.start(startTime);
                oscillator.stop(startTime + duration);
                
                currentOscillators.add(oscillator);
                oscillator.onended = () => {
                    currentOscillators.delete(oscillator);
                    gainNode.disconnect();
                };
            } catch (e) {
                console.error("PlayNote error:", e);
            }
        }


        // 播放語音提示
        function speakAlertText(volume) {
            return new Promise((resolve, reject) => {
                if (!('speechSynthesis' in window)) {
                    console.warn("瀏覽器不支援語音合成。");
                    return resolve(); // 靜默失敗
                }
                
                // 檢查是否被 stopAlarm() 停止了
                if (!isSoundPlaying) {
                    console.log("語音被取消 (isSoundPlaying=false)");
                    return resolve();
                }

                const utterance = new SpeechSynthesisUtterance("請支援住戶");
                utterance.lang = 'zh-TW';
                utterance.volume = parseFloat(volume); // 從滑桿讀取音量
                utterance.rate = 1.0;
                
                utterance.onend = () => {
                    console.log("語音播放完畢。");
                    resolve();
                };
                utterance.onerror = (e) => {
                    console.error("語音播放錯誤:", e);
                    resolve(); // 即使錯誤也 resolve，避免流程卡住
                };
                
                // 確保之前的語音已清除
                window.speechSynthesis.cancel();
                window.speechSynthesis.speak(utterance);
            });
        }

        // 組合播放（先語音，再無限鈴聲）
        async function playAlertSound() {
            if (isSoundPlaying) {
                console.log("聲音已在播放，跳過。");
                return;
            }
            
            isSoundPlaying = true;
            console.log("--- 開始播放警報音 (語音優先) ---");
            
            try {
                // 確保 AudioContext 在用戶互動後恢復
                if (audioCtx && audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }

                const volume = volumeSlider.value;
                
                // 1. 先播放語音
                await speakAlertText(volume); 
                
                // 2. 檢查語音播放後是否被停止
                if (!isSoundPlaying) {
                    console.log("警報在語音播放期間被停止。");
                    return;
                }
                
                // 3. 開始無限循環鈴聲
                console.log("語音完畢，開始播放無限鈴聲...");
                playRingTone(volume); 

            } catch (error) {
                console.error("播放警報音時發生錯誤:", error);
                // 即使出錯也要重設
                isSoundPlaying = false;
            } 
        }

        // --- 6. 啟動 App ---
        initializeFirebase();

    </script>
</body>
</html>
